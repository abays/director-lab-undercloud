---
- name: get current MAC of default interface
  shell: virsh domiflist undercloud | awk '/default/ {print $5};'
  register: vm_mac

- name: check if host already knows of vm
  shell: ip n | grep {{ vm_mac.stdout }} | awk '{print $1}'
  register: vm_ip

- name: get current IP of default interface
  shell: virsh net-dhcp-leases --network default | grep {{ vm_mac.stdout }} | awk '{print $5}' | cut -d / -f 1 
  register: vm_ip2
  until: vm_ip2.stdout != ''
  retries: 6
  delay: 15
  when: vm_ip.stdout == ''

- name: set IP
  set_fact: vm_ip="{{ vm_ip2 }}"
  when: vm_ip.stdout == ''

#- name: DEBUG
#  debug: var=vm_mac

#- name: DEBUG
#  debug: var=vm_ip

- name: add vm to undercloud host group
  add_host:
    name: "{{ vm_ip.stdout }}"
    groups: undercloud
    ansible_host: "{{ vm_ip.stdout }}"
    ansible_user: "root"
    ansible_ssh_pass: "Redhat01"
    #ansible_ssh_private_key_file: "{{ vm_key.stdout }}"
    ansible_become: true

- name: give vm ssh a minute to come up
  pause: minutes=1
  when: ({{ post_haste }} == false)
